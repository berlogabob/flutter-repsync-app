rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function isBandMember(bandId) {
      let band = get(/databases/$(database)/documents/users/$(request.auth.uid)/bands/$(bandId)).data;
      return band != null && (band.members as list).hasAny([request.auth.uid]);
    }
    
    // Test suite for users collection
    match /users/{userId} {
      
      // Test: Users can read/write their own data
      match /songs/{songId} {
        allow read: if isAuthenticated() && isOwner(userId);
        allow write: if isAuthenticated() && isOwner(userId);
      }
      
      match /bands/{bandId} {
        allow read: if isAuthenticated() && (isOwner(userId) || isBandMember(bandId));
        allow write: if isAuthenticated() && isOwner(userId);
        allow create: if isAuthenticated() && isOwner(userId);
        
        match /members/{memberId} {
          allow read: if isAuthenticated() && (isOwner(userId) || isBandMember(bandId));
          allow write: if isAuthenticated() && isOwner(userId);
        }
      }
      
      match /setlists/{setlistId} {
        allow read: if isAuthenticated() && isOwner(userId);
        allow write: if isAuthenticated() && isOwner(userId);
      }
    }
  }
}

// ============================================
// TEST CASES (for Firebase Emulator Suite)
// ============================================

// Test Case 1: User can read their own songs
// match /users/{userId}/songs/{songId} {
//   allow read: if request.auth.uid == userId;
// }
// Test: PASS - Authenticated user with matching userId can read
// Test: FAIL - Unauthenticated user cannot read
// Test: FAIL - Authenticated user with different userId cannot read

// Test Case 2: User can write their own songs
// match /users/{userId}/songs/{songId} {
//   allow write: if request.auth.uid == userId;
// }
// Test: PASS - Authenticated user with matching userId can create/update/delete
// Test: FAIL - Unauthenticated user cannot write
// Test: FAIL - Authenticated user with different userId cannot write

// Test Case 3: Band members can read band data
// match /users/{userId}/bands/{bandId} {
//   allow read: if request.auth.uid == userId || 
//               get(/databases/$(database)/documents/users/$(request.auth.uid)/bands/$(bandId)).data.members.hasAny([request.auth.uid]);
// }
// Test: PASS - Band owner can read
// Test: PASS - Band member can read
// Test: FAIL - Non-member cannot read

// Test Case 4: Only band owner can write band data
// match /users/{userId}/bands/{bandId} {
//   allow write: if request.auth.uid == userId;
// }
// Test: PASS - Band owner can update band
// Test: FAIL - Band member (non-owner) cannot update
// Test: FAIL - Non-member cannot update

// Test Case 5: User can read/write their own setlists
// match /users/{userId}/setlists/{setlistId} {
//   allow read, write: if request.auth.uid == userId;
// }
// Test: PASS - Owner can read/write setlists
// Test: FAIL - Non-owner cannot read/write

// ============================================
// HOW TO RUN TESTS
// ============================================
// 1. Install Firebase Emulator Suite:
//    npm install -g firebase-tools
// 
// 2. Login to Firebase:
//    firebase login
// 
// 3. Initialize emulators:
//    firebase init emulators
// 
// 4. Run emulator with tests:
//    firebase emulators:start --only firestore
// 
// 5. Run test suite:
//    firebase emulators:exec --only firestore "npm test"
// 
// 6. Or use the Rules Playground in Firebase Console:
//    - Go to Firebase Console > Firestore > Rules
//    - Click "Rules Playground"
//    - Add test cases and simulate requests
